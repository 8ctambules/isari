<md-card>
    <md-toolbar>
      <span>{{ 'editLogs.title' | translate }} : {{ feature | translate }}</span>
      &nbsp;

      <isari-date
        [form]="filterForm"
        name="startDate"
        [label]="'startDate' | translate"
        [requirement]="false"></isari-date>

      <isari-date
        [form]="filterForm"
        name="endDate"
        [label]="'endDate' | translate"
        [requirement]="false"></isari-date>

      <md-checkbox (change)="toggleView()">{{ 'editLogs.details' | translate }}</md-checkbox>

    </md-toolbar>

    <table class="striped bordered">

          <thead>
            <tr>
              <th>{{ 'editLogs.date' | translate }}</th>
              <th *ngIf="!hideItemCol">
                  <isari-select
                    [src]="itemSettings.src"
                    [stringValue]="itemSettings.stringValue"
                    api="people"
                    [name]="'itemID'"
                    [label]="'editLogs.object.' + feature | translate"
                    [requirement]="false"
                    [form]="filterForm"></isari-select>
              </th>
              <th>
                <md-select [placeholder]="'editLogs.action' | translate" [formControl]="filterForm.controls['action']" *ngIf="filterForm.controls['action']">
                  <md-option>{{ 'editLogs.actions.all' | translate }}</md-option>
                  <md-option *ngFor="let action of actions" [value]="action">{{ 'editLogs.actions.' + action | translate }}</md-option>
                </md-select>
              </th>

              <th>
                <md-select *ngIf="filterForm.controls['path']"
                  [placeholder]="'editLogs.fields' | translate"
                  [formControl]="filterForm.controls['path']">
                  <md-option>{{ 'editLogs.actions.all' | translate }}</md-option>
                  <md-option *ngFor="let field of fields" [value]="field.value">{{ field.label }}</md-option>
                </md-select>
              </th>

              <th style="max-width:25%;border:1px solid #ddd;background:#f2f2f2;">
                <div style="display:flex">
                  <isari-select
                    style="flex-grow:1;width:33%;"
                    [src]="whoSettings.src"
                    [stringValue]="whoSettings.stringValue"
                    api="people"
                    [name]="'whoID'"
                    [label]="'editLogs.who' | translate"
                    [requirement]="false"
                    [form]="filterForm"></isari-select>
                  <isari-select
                    style="flex-grow:1;width:33%;"
                    [src]="labSettings.src"
                    [stringValue]="labSettings.stringValue"
                    api="organizations"
                    [name]="'isariLab'"
                    [label]="'editLogs.lab' | translate"
                    [requirement]="false"
                    [form]="filterForm"></isari-select>
                  <md-select *ngIf="filterForm.controls['isariRole']"
                    style="flex-grow:1;width:33%;align-self:center;"
                    [placeholder]="'editLogs.role' | translate"
                    [formControl]="filterForm.controls['isariRole']">
                    <md-option>{{ 'editLogs.actions.all' | translate }}</md-option>
                    <md-option *ngFor="let role of roles" [value]="role.value">{{ role.label }}</md-option>
                  </md-select>
                </div>
              </th>

            </tr>
          </thead>

          <tbody *ngIf="logs; else loading">
            <tr *ngIf="!logs.length">
              <td [colSpan]="hideItemCol ? 4 : 5" style="text-align:center;">{{ 'no result' | translate }}</td>
            </tr>
            <ng-template ngFor let-log [ngForOf]="logs" let-i="index">
              <tr [class.open1]="log._open" [class.odd]="i % 2 === 0">

                <td>{{ log.date | date:'yyyy-MM-dd HH:mm' }}</td>
                <td *ngIf="!hideItemCol">
                    <a *ngIf="log.action !== 'delete';else nolink" [routerLink]="['/', feature, { outlets: { editor: log.item.id } }]" queryParamsHandling="preserve">{{ log.item.name }}</a>
                    <ng-template #nolink>{{ log.item.name }}</ng-template>
                </td>
                <td [class.bleft]="log._open">{{ 'editLogs.actions.' + log.action | translate }}</td>
                <td class="labels" (click)="toggle(log, $event)">
                  <md-icon *ngIf="!log._open">expand_more</md-icon>
                  <md-icon *ngIf="log._open">expand_less</md-icon>
                  <p *ngFor="let label of log._labels">{{ label }}</p>
                </td>
                <td>
                  <div style="display:flex">
                    <div style="flex-grow:1;width:33%;">{{ log.who.name }}</div>
                    <div style="flex-grow:1;width:33%;">
                        <p *ngFor="let role of log.who.roles">
                        <span *ngIf="labs && role.lab">{{ labs[role.lab]?.value }}</span>
                      </p>
                    </div>
                    <div style="flex-grow:1;width:33%;">
                        <p *ngFor="let role of log.who.roles">{{ role._label }}</p>
                    </div>
                  </div>
                </td>

              </tr>
              <ng-template [ngIf]="log._open">
              <ng-template ngFor let-diff [ngForOf]="log.diff" let-j="index" let-islast="last">
              <tr class="open2" [class.odd]="i % 2 === 0" [class.last]="islast">
                <td></td>
                <td *ngIf="!hideItemCol"></td>
                <td [class.bleft]="log._open">{{ 'editLogs.actions.' + diff.editType | translate }}</td>
                <td>{{ diff._label }}</td>
                <td colspan="2">
                  <pre style="color:red;" [innerHTML]="diff._beforeLabelled$ | async"></pre>
                  <pre style="color:green;" [innerHTML]="diff._afterLabelled$ | async"></pre>
                </td>
              </tr>
              </ng-template>
              </ng-template>
            </ng-template>
          </tbody>

          <ng-template #loading>
            <tbody>
              <tr>
                <td [colSpan]="hideItemCol ? 4 : 5">
                  <isari-spinner></isari-spinner>
                </td>
              </tr>
            </tbody>
          </ng-template>

        </table>

        <div class="pagination">
          <ul>
            <li><a md-button (click)="navigatePrev()"><md-icon>navigate_before</md-icon></a>
            <li><a md-button (click)="navigateNext()"><md-icon>navigate_next</md-icon></a>
          </ul>

          <md-select style="align-self:flex-end" [placeholder]="'editLogs.limit' | translate" [formControl]="filterForm.controls['limit']" *ngIf="filterForm.controls['limit']">
              <md-option *ngFor="let limit of limits" [value]="limit">{{ limit }}</md-option>
          </md-select>

        </div>

        <!-- remove me style WTF ??? -->
        <md-input style="display:none" placeholder="Company (disabled)" disabled value="Google"></md-input>

</md-card>

